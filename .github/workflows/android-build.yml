name: Android Release (No ICU)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-linux-android
            name: arm64
          - target: armv7-linux-androideabi
            name: armv7

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}

      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # 自动修复 32 位源码报错
      - name: Patch Source Code
        run: |
          if [ -f crates/edit/src/sys/unix.rs ]; then
            sed -i 's/st_dev: stat.st_dev/st_dev: stat.st_dev as _/g' crates/edit/src/sys/unix.rs
            sed -i 's/st_ino: stat.st_ino/st_ino: stat.st_ino as _/g' crates/edit/src/sys/unix.rs
            echo "Patch applied."
          fi

      # 1. 编译标准版 (带正则，约 700KB)
      - name: Build Full Version (With Regex)
        run: |
          cross build --target ${{ matrix.target }} --config .cargo/release-nightly.toml --release --config profile.release.strip=true --config profile.release.lto=true
          
          # 重命名移动
          SRC="target/${{ matrix.target }}/release"
          if [ -f "$SRC/edit" ]; then mv "$SRC/edit" "edit-full"; fi
          if [ -f "$SRC/msedit" ]; then mv "$SRC/msedit" "msedit-full"; fi

      # 2. 编译极简版 (无正则，约 150KB)
      - name: Build Lite Version (No Regex)
        run: |
          cross build --target ${{ matrix.target }} --config .cargo/release-nightly.toml --release --no-default-features --config profile.release.strip=true --config profile.release.lto=true
          
          # 重命名移动
          SRC="target/${{ matrix.target }}/release"
          if [ -f "$SRC/edit" ]; then mv "$SRC/edit" "edit-lite"; fi
          if [ -f "$SRC/msedit" ]; then mv "$SRC/msedit" "msedit-lite"; fi

      - name: Prepare Release Files
        run: |
          # 整理文件名，加上架构后缀
          mv edit-full edit-full-${{ github.ref_name }}-${{ matrix.name }}
          mv edit-lite edit-lite-${{ github.ref_name }}-${{ matrix.name }}

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            edit-full-*
            edit-lite-*